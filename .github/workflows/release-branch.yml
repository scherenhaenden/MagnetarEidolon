name: Release Branch Delivery

on:
  push:
    branches:
      - release

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version metadata
        id: meta
        run: |
          VERSION=$(python - <<'PY'
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          print(data["tool"]["poetry"]["version"])
          PY
          )

          TAG="v${VERSION}"
          RELEASE_NAME="Release ${TAG} (${GITHUB_SHA::7})"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Persist autogenerated release notes
        run: |
          cat > RELEASE_NOTES_AUTOMATED.md <<EOF
          ## Automated release delivery from branch \`release\`

          - Version: \`${{ steps.meta.outputs.version }}\`
          - Commit: \`${GITHUB_SHA}\`
          - Workflow run: \`${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\`

          This release was generated automatically after a merge/push to \`release\`.
          Assets are uploaded for every platform build that succeeded.
          EOF

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: automated-release-notes
          path: RELEASE_NOTES_AUTOMATED.md

  build_linux:
    name: Build release assets (linux)
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pyinstaller rich
          pip install .

      - name: Build source and wheel distributions
        run: python -m build

      - name: Build OS-specific standalone CLI binary
        run: >-
          python -m PyInstaller
          --onefile
          --name magnetar-linux
          src/magnetar/cli.py

      - name: Collect release assets
        run: |
          mkdir -p release-assets
          cp dist/* release-assets/
          cp dist/magnetar-linux release-assets/

      - name: Upload release asset bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-linux
          path: release-assets/*

  build_macos:
    name: Build release assets (macos)
    needs: prepare
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pyinstaller rich
          pip install .

      - name: Build source and wheel distributions
        run: python -m build

      - name: Build OS-specific standalone CLI binary
        run: >-
          python -m PyInstaller
          --onefile
          --name magnetar-macos
          src/magnetar/cli.py

      - name: Collect release assets
        run: |
          mkdir -p release-assets
          cp dist/magnetar-macos release-assets/

      - name: Upload release asset bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-macos
          path: release-assets/*

  build_windows:
    name: Build release assets (windows)
    needs: prepare
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pyinstaller rich
          pip install .

      - name: Build source and wheel distributions
        run: python -m build

      - name: Build OS-specific standalone CLI binary
        run: >-
          python -m PyInstaller
          --onefile
          --name magnetar-windows
          src/magnetar/cli.py

      - name: Collect release assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path release-assets -Force | Out-Null
          Copy-Item -Path dist\magnetar-windows.exe -Destination release-assets -Force

      - name: Upload release asset bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-windows
          path: release-assets/*

  github_release:
    name: Publish GitHub release with available assets
    if: >-
      always() &&
      (needs.build_linux.result == 'success' || needs.build_macos.result == 'success' || needs.build_windows.result == 'success')
    needs: [prepare, build_linux, build_macos, build_windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: automated-release-notes
          path: release-notes

      - name: Download Linux artifacts
        if: needs.build_linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: release-assets-linux
          path: release-assets/linux

      - name: Download macOS artifacts
        if: needs.build_macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: release-assets-macos
          path: release-assets/macos

      - name: Download Windows artifacts
        if: needs.build_windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: release-assets-windows
          path: release-assets/windows

      - name: Ensure at least one release artifact exists
        run: |
          if ! find release-assets -type f | grep -q .; then
            echo "No release artifacts were produced by any platform build job."
            exit 1
          fi

      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ needs.prepare.outputs.release_name }}
          body_path: release-notes/RELEASE_NOTES_AUTOMATED.md
          overwrite_files: true
          files: |
            release-assets/linux/*
            release-assets/macos/*
            release-assets/windows/*
