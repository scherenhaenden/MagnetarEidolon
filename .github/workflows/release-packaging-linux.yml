name: Release Packaging Linux

on:
  workflow_call:
    inputs:
      tag:
        description: "Git tag to checkout for release packaging"
        required: true
        type: string
      version:
        description: "Release semantic version"
        required: true
        type: string

jobs:
  build_linux_packages:
    name: Build Linux package formats
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          if apt-cache show libfuse2 >/dev/null 2>&1; then
            FUSE_PACKAGE="libfuse2"
          else
            FUSE_PACKAGE="libfuse2t64"
          fi

          sudo apt-get install -y ruby ruby-dev rpm squashfs-tools desktop-file-utils "$FUSE_PACKAGE"
          sudo gem install --no-document fpm
          python -m pip install --upgrade pip
          pip install pyinstaller rich
          pip install .

      - name: Build Linux standalone binary
        run: >-
          python -m PyInstaller
          --onefile
          --name magnetar-linux-x86_64
          src/magnetar/cli.py

      - name: Build DEB and RPM packages
        env:
          VERSION: ${{ inputs.version }}
        run: |
          mkdir -p package-root/usr/local/bin
          install -m 0755 dist/magnetar-linux-x86_64 package-root/usr/local/bin/magnetar

          fpm -s dir -t deb -n magnetar -v "$VERSION" --architecture amd64 \
            --description "Magnetar CLI" --url "https://github.com/${GITHUB_REPOSITORY}" \
            -C package-root usr/local/bin/magnetar

          fpm -s dir -t rpm -n magnetar -v "$VERSION" --architecture x86_64 \
            --description "Magnetar CLI" --url "https://github.com/${GITHUB_REPOSITORY}" \
            -C package-root usr/local/bin/magnetar

      - name: Build AppImage
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications
          install -m 0755 dist/magnetar-linux-x86_64 AppDir/usr/bin/magnetar
          cat > AppDir/usr/share/applications/magnetar.desktop <<'EOF'
          [Desktop Entry]
          Name=Magnetar
          Exec=magnetar
          Type=Application
          Categories=Utility;
          Terminal=true
          EOF
          cp AppDir/usr/share/applications/magnetar.desktop AppDir/magnetar.desktop

          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool AppDir magnetar-${{ inputs.version }}-x86_64.AppImage

      - name: Prepare snapcraft definition
        run: |
          mkdir -p snap
          cat > snap/snapcraft.yaml <<'EOF'
          name: magnetar
          base: core22
          version: '${{ inputs.version }}'
          summary: Magnetar CLI
          description: |
            Magnetar command line interface packaged as a snap.
          grade: stable
          confinement: strict

          apps:
            magnetar:
              command: bin/magnetar

          parts:
            magnetar:
              plugin: dump
              source: dist
              organize:
                magnetar-linux-x86_64: bin/magnetar
          EOF

      - name: Build SNAP package
        uses: snapcore/action-build@v1
        with:
          snapcraft-args: --destructive-mode

      - name: Collect Linux packaging artifacts
        run: |
          mkdir -p release-assets
          cp *.deb release-assets/
          cp *.rpm release-assets/
          cp *.AppImage release-assets/
          cp *.snap release-assets/
          cp dist/magnetar-linux-x86_64 release-assets/

      - name: Upload Linux packaging artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-linux-packaging
          path: release-assets/*
